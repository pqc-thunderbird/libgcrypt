/* t-dilithium.c - Test the Crystals-Dilithium Signature algorithm
 * Copyright (C) 2011 Free Software Foundation, Inc.
 *
 * This file is part of Libgcrypt.
 *
 * Libgcrypt is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * Libgcrypt is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this program; if not, see <http://www.gnu.org/licenses/>.
 */


#ifdef HAVE_CONFIG_H
#include <config.h>
#endif

#include "gcrypt.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdarg.h>


#define PGM "t-dilithium"
#include "t-common.h"
//#define N_TESTS 120

#ifdef HAVE_CONFIG_H
#include <config.h>
#endif


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <ctype.h>


//#define PGM "test-utils"
//#include "t-common.h"

#define digitp(p)     (*(p) >= '0' && *(p) <= '9')
#define hexdigitp(a)  (digitp (a)                     \
                       || (*(a) >= 'A' && *(a) <= 'F')  \
                       || (*(a) >= 'a' && *(a) <= 'f'))
#define xtoi_1(p)     (*(p) <= '9'? (*(p)- '0'): \
                       *(p) <= 'F'? (*(p)-'A'+10):(*(p)-'a'+10))
#define xtoi_2(p)     ((xtoi_1(p) * 16) + xtoi_1((p)+1))
#define xmalloc(a)    gcry_xmalloc ((a))
#define xcalloc(a,b)  gcry_xcalloc ((a),(b))
#define xstrdup(a)    gcry_xstrdup ((a))
#define xfree(a)      gcry_free ((a))
#define pass()        do { ; } while (0)


/* Prepend FNAME with the srcdir environment variable's value and
 * return an allocated filename.  */
char *
prepend_srcdir (const char *fname)
{
  static const char *srcdir;
  char *result;

  if (!srcdir && !(srcdir = getenv ("srcdir")))
    srcdir = ".";

  result = xmalloc (strlen (srcdir) + 1 + strlen (fname) + 1);
  strcpy (result, srcdir);
  strcat (result, "/");
  strcat (result, fname);
  return result;
}

/* Read next line but skip over empty and comment lines.  Caller must
   xfree the result.  */
static char *
read_textline (FILE *fp, int *lineno)
{
  char line[40000];
  char *p;

  do
    {
      if (!fgets (line, sizeof line, fp))
        {
          if (feof (fp))
            return NULL;
          die ("error reading input line: %s\n", strerror (errno));
        }
      ++*lineno;
      p = strchr (line, '\n');
      if (!p)
        die ("input line %d not terminated or too long\n", *lineno);
      *p = 0;
      for (p--;p > line && my_isascii (*p) && isspace (*p); p--)
        *p = 0;
    }
  while (!*line || *line == '#');
  /* if (debug) */
  /*   info ("read line: '%s'\n", line); */
  return xstrdup (line);
}

/**
 * Convert STRING consisting of hex characters into its binary
 * representation and return it as an allocated buffer.
 *
 * @param string in hex string to convert. The string is delimited by end of string.
 * @param r_length out pointer to the resulting (returned) buffer length.
 *
 * @return pointer to hex decoded binary. The function returns NULL on error.
 **/
static void *
hex2buffer (const char *string, size_t *r_length)
{
  const char *s;
  unsigned char *buffer;
  size_t length;
  size_t str_len = strlen(string);
  *r_length = 0;
  if(str_len % 2)
  {
    return NULL;
  }
  buffer = xmalloc (strlen(string)/2+1);
  length = 0;
  for (s=string; *s; s +=2 )
    {
      if (!hexdigitp (s) || !hexdigitp (s+1))
        {
          xfree (buffer);
          return NULL;           /* Invalid hex digits. */
        }
      ((unsigned char*)buffer)[length++] = xtoi_2 (s);
    }
  *r_length = length;
  return buffer;
}

/* Copy the data after the tag to BUFFER.  BUFFER will be allocated as
   needed.  */
static unsigned char*
fill_bin_buf_from_hex_line(size_t* r_length, const char tag_char, const char *line, int lineno)
{
  const char *s;


  s = strchr (line, tag_char);
  if (!s)
    {
      fail ("syntax error at input line %d", lineno);
      return NULL;
    }
  s++;
  while(strlen(s) && s[0] == ' ')
  {
    s++;
  }
  /*for (s++; my_isascii (*s) && isspace (*s); s++)
    ;
  *buffer = xstrdup (s);*/
  return hex2buffer(s, r_length);
}



/*
* TODO: include test-utils.h when merging with kyber branch
*/


#define GCRY_DILITHIUM2_NBITS (1312 * 8) 10496
#define GCRY_DILITHIUM3_NBITS (1952 * 8) 15616
#define GCRY_DILITHIUM5_NBITS (2592 * 8) 20736

static int check_dilithium_roundtrip()
{
  char *dilithium_name[] = {"Dilithium2", "Dilithium3", "Dilithium5"};
  unsigned dilithium_nbits[] = {10496, 15616, 20736};

  int rc;

  for (int i = 0; i < sizeof(dilithium_name)/sizeof(dilithium_name[0]); i++)
  {
    gcry_sexp_t skey = NULL;
    gcry_sexp_t pkey = NULL;
    gcry_sexp_t keyparm = NULL;
    gcry_sexp_t key = NULL;
    gcry_sexp_t l = NULL;

    gcry_sexp_t r_sig = NULL;
    gcry_sexp_t s_data = NULL;
    gcry_sexp_t s_data_wrong = NULL;

    if (verbose)
      info ("creating %s key\n", dilithium_name[i]);

    rc = gcry_sexp_build(&keyparm,
                        NULL,
                        "(genkey (dilithium (nbits%u)))",
                        dilithium_nbits[i],
                        NULL);

    if (rc)
      die ("error creating S-expression: %s\n", gpg_strerror (rc));
    rc = gcry_pk_genkey (&key, keyparm);

    if (rc)
      die ("error generating Dilithium key: %s\n", gpg_strerror (rc));


    pkey = gcry_sexp_find_token (key, "public-key", 0);
    if (!pkey)
    {
      die("public part missing in return value\n");
    }

    skey = gcry_sexp_find_token (key, "private-key", 0);
    if (!skey)
      die("private part missing in return value\n");




    rc = gcry_sexp_new (&s_data,
      "(data (value 7:message))", 0, 1);
    if(rc)
      die("gcry_sexp_build failed\n");

    rc = gcry_pk_sign (&r_sig, s_data, skey);
    if(rc)
      die("sign failed\n");

    printf("verifying correct signature\n");
    rc = gcry_pk_verify (r_sig, s_data, pkey);
    if(rc)
      die("verify failed\n");
    printf("... ok!\n");

    printf("verifying wrong signature\n");
    rc = gcry_sexp_new (&s_data_wrong,
      "(data (value 8:message2))", 0, 1);

    rc = gcry_pk_verify (r_sig, s_data_wrong, pkey);
    if(!rc)
      die("verify succesful for wrong data\n");
    printf("... ok!\n");
    rc = 0;

    gcry_sexp_release(skey);
    gcry_sexp_release(pkey);
    gcry_sexp_release(keyparm);
    gcry_sexp_release(key);
    gcry_sexp_release(l);

    gcry_sexp_release(r_sig);
    gcry_sexp_release(s_data);
    gcry_sexp_release(s_data_wrong);
  }

  return rc;
}

typedef struct
{
  const char *index;
  unsigned char *result_buf;
  size_t result_buf_len;
} test_vec_desc_entry;

static void check_dilithium_kat(const char *fname, unsigned dilithium_bits)
{
  const size_t nb_kat_tests = 0; /* zero means all */
  FILE *fp;
  int lineno = 0;
  char *line;

  enum
  {
    public_key_idx    = 0,
    privat_key_idx    = 1,
    signature_idx    = 2,
    msg_idx = 3
  };

  test_vec_desc_entry test_vec[] = {/*{
                                        "count:",
                                        NULL,
                                        0,
                                    },*/
                                    {
                                        "seed",
                                        NULL,
                                        0,
                                    },/*
                                    {
                                        "mlen:",
                                        NULL,
                                        0,
                                    },*/
                                    {
                                        "msg",
                                        NULL,
                                        0,
                                    },
                                    {
                                        "pk",
                                        NULL,
                                        0,
                                    },
                                    {
                                        "sk",
                                        NULL,
                                        0,
                                    },/*
                                    {
                                        "smlen:",
                                        NULL,
                                        0,
                                    },*/
                                    {
                                        "sm",
                                        NULL,
                                        0,
                                    }};
  size_t test_count              = 0;
  gcry_sexp_t public_key_sx = NULL, private_key_sx = NULL,
              signature_sx = NULL,
              msg_sx = NULL;


  info("Checking Kyber KAT.\n");

  fp = fopen(fname, "r");
  if (!fp)
    die("error opening '%s': %s\n", fname, strerror(errno));


  while ((line = read_textline(fp, &lineno))
         && !(nb_kat_tests && nb_kat_tests <= test_count))
    {
      gcry_sexp_t l;
      int have_flags;
      int rc;
      int is_complete = 1;
      gcry_error_t err;
      unsigned i;

      /* read in test vec */
      for (i = 0; i < sizeof(test_vec) / sizeof(test_vec[0]); i++)
        {
          test_vec_desc_entry *e = &test_vec[i];
          if (!strncmp(line, "#", 1)
                   || !strncmp(line, "\n", 1)
                   || !strncmp(line, "count", 5)
                   || !strncmp(line, "mlen", 4)
                   || !strncmp(line, "smlen", 5))
            {
              continue;
            }
          else if (!strncmp(line, e->index, strlen(e->index)))
            {
              if (e->result_buf != NULL)
                {
                  fail("trying to set test vector element twice");
                }
              e->result_buf = fill_bin_buf_from_hex_line(
                  &e->result_buf_len, '=', line, lineno);
              break;
            }
        }

      // check if we completed one test vector:
      for (i = 0; i < sizeof(test_vec) / sizeof(test_vec[0]); i++)
        {
          is_complete &= (test_vec[i].result_buf != NULL);
        }
      if (!is_complete)
        {
          // printf("line '%s' does NOT complete a test vector\n", line);
          xfree(line);
          continue;
        }
      else
        {
          // printf("line '%s' COMPLETES a test vector\n", line);
        }
      test_count++;

      // NOTE: sm = (sig | m)
      unsigned char *sig = test_vec[4].result_buf;
      unsigned sig_len = test_vec[4].result_buf_len - test_vec[1].result_buf_len;
      rc = check_test_vec_verify(test_vec[2].result_buf, test_vec[2].result_buf_len, test_vec[1].result_buf, test_vec[1].result_buf_len, sig, sig_len);
      if(rc)
        die("Failed to verify KAT test vector");


      // free test vec
      xfree(line);
      for (i = 0; i < sizeof(test_vec) / sizeof(test_vec[0]); i++)
        {
          test_vec_desc_entry *e = &test_vec[i];
          if (e->result_buf)
            {
              xfree(e->result_buf);
            }
          e->result_buf     = NULL;
          e->result_buf_len = 0;
        }
#if 0
      err = gcry_sexp_build(&private_key_sx,
                            NULL,
                            "(private-key (kyber (s %b) (nbits%u) ))",
                            (int)test_vec[privat_key_idx].result_buf_len,
                            test_vec[privat_key_idx].result_buf,
                            kyber_bits,
                            NULL);
      if (err)
        {
          fail("error building private key SEXP for test, %s: %s",
               "sk",
               gpg_strerror(err));
          goto leave;
        }
#if 0
        printf("private key sx directly after building:\n");
        gcry_sexp_dump(private_key_sx);
        char print_buf[100000];
        gcry_sexp_sprint(private_key_sx, GCRYSEXP_FMT_ADVANCED, print_buf, sizeof(print_buf)-1);
        printf("private_key_sx: %s", print_buf);
#endif

      err = gcry_sexp_build(&shared_secret_expected_sx,
                            NULL,
                            "(data (value %b))",
                            (int)test_vec[msg_idx].result_buf_len,
                            test_vec[msg_idx].result_buf);
      if (err)
        {
          fail("error building expected shared secret SEXP for test, %s: %s",
               "pk",
               gpg_strerror(err));
          goto leave;
        }

      l = gcry_sexp_find_token(shared_secret_expected_sx, "value", 0);
      ss_expected = gcry_sexp_nth_mpi(l, 1, GCRYMPI_FMT_USG);
      gcry_sexp_release(l);

      err = gcry_sexp_build(&signature_sx,
                            NULL,
                            "(ciphertext (kyber(c %b)))",
                            (int)test_vec[signature_idx].result_buf_len,
                            test_vec[signature_idx].result_buf);
      if (err)
        {
          fail("error building ciphertext SEXP for test, %s: %s",
               "pk",
               gpg_strerror(err));
          goto leave;
        }

      l          = gcry_sexp_find_token(signature_sx, "flags", 0);
      have_flags = !!l;
      gcry_sexp_release(l);


      // l = gcry_sexp_find_token (signature_sx, "flags", 0); // why no leak
      // when this was in?
      rc = gcry_pk_decrypt(&shared_secret_sx, signature_sx, private_key_sx);
      if (rc)
        {
          die("decryption failed: %s\n", gcry_strerror(rc));
        }

      l = gcry_sexp_find_token(shared_secret_sx, "value", 0);
      if (l)
        {
          if (!have_flags)
            {
              // printf("compatibility mode of pk_decrypt broken:
              // !have_flags\n"); die ("compatibility mode of pk_decrypt
              // broken: !have_flags\n");
            }
          ss = gcry_sexp_nth_mpi(l, 1, GCRYMPI_FMT_USG);
          gcry_sexp_release(l);
        }
      else
        {
          if (have_flags)
            // die ("compatibility mode of pk_decrypt broken: have_flags is
            // true\n");
            ss = gcry_sexp_nth_mpi(shared_secret_sx, 0, GCRYMPI_FMT_USG);
        }
      if (!ss)
        {
          die("ss = NULL\n");
        }
      if (!ss_expected)
        {
          die("ss_expected = NULL\n");
        }

      /* Compare.  */
      if (gcry_mpi_cmp(ss_expected, ss))
        {
          die("error with decryption result\n");
        }
      printf(".");


      xfree(line);
      for (i = 0; i < sizeof(test_vec) / sizeof(test_vec[0]); i++)
        {
          test_vec_desc_entry *e = &test_vec[i];
          if (e->result_buf)
            {
              xfree(e->result_buf);
            }
          e->result_buf     = NULL;
          e->result_buf_len = 0;
        }

      gcry_sexp_release(public_key_sx);
      public_key_sx = NULL;
      gcry_sexp_release(private_key_sx);
      private_key_sx = NULL;
      gcry_sexp_release(signature_sx);
      signature_sx = NULL;
      gcry_sexp_release(shared_secret_sx);
      shared_secret_sx = NULL;
      gcry_sexp_release(shared_secret_expected_sx);
      shared_secret_expected_sx = NULL;
      gcry_mpi_release(ss_expected);
      ss_expected = NULL;
      gcry_mpi_release(ss);
      ss = NULL;
  #endif
    }

  printf("\n");
  xfree(line);
leave:
  line = line;
}


   unsigned char dilithium2_pk_buf[] = {
  0x6a, 0x7e, 0x97, 0x12, 0x85, 0x24, 0x47, 0xaf, 0xd6, 0x8a, 0x18, 0xa7, 0x36, 0xdd, 0x4b, 0x6c,
  0x41, 0x72, 0xc6, 0x76, 0xbf, 0xf8, 0x97, 0xf0, 0x47, 0xcf, 0xdc, 0x4c, 0x4d, 0xb2, 0x4b, 0x7d,
  0x78, 0x95, 0xe9, 0x86, 0x64, 0xdb, 0x20, 0x7d, 0xd7, 0x7a, 0xb0, 0xe8, 0x75, 0x88, 0x46, 0x89,
  0xbf, 0x66, 0x37, 0x67, 0xd3, 0xb8, 0x9d, 0x1c, 0x97, 0x5b, 0x28, 0xad, 0x4e, 0x1c, 0x0c, 0x3a,
  0x28, 0xfa, 0x81, 0x8e, 0x72, 0xfc, 0x37, 0xed, 0xb7, 0x53, 0x54, 0x9e, 0xc8, 0x40, 0xc8, 0xe1,
  0xbf, 0x74, 0xdf, 0x46, 0x55, 0xa6, 0x8c, 0xa9, 0x09, 0xab, 0x6d, 0x2c, 0xa6, 0x35, 0xd8, 0x50,
  0xe4, 0xea, 0x69, 0xb7, 0x74, 0x7d, 0xbc, 0xac, 0x9b, 0xab, 0xb0, 0x3e, 0xf9, 0xf1, 0x63, 0xe2,
  0x37, 0x28, 0xda, 0x94, 0x67, 0x1b, 0x98, 0x98, 0x35, 0x95, 0xb8, 0xa3, 0x26, 0x97, 0x1c, 0xc7,
  0x39, 0xc9, 0xe0, 0x21, 0x0c, 0x3e, 0xc4, 0x60, 0x76, 0x9a, 0xd3, 0xe2, 0x60, 0x36, 0x4a, 0x75,
  0xda, 0xeb, 0x8f, 0xab, 0xd7, 0x69, 0xfe, 0xfd, 0x1c, 0x6f, 0x7f, 0xc9, 0x32, 0xaa, 0xda, 0x27,
  0x40, 0x08, 0xf9, 0x0e, 0xc3, 0xba, 0x18, 0x3b, 0x5a, 0xbb, 0x50, 0x25, 0x09, 0x04, 0xee, 0xf1,
  0x4a, 0x35, 0xa9, 0x62, 0xa8, 0xa5, 0xe0, 0xf8, 0x81, 0x0f, 0x04, 0x11, 0xe3, 0x91, 0xb7, 0xa0,
  0xf4, 0x58, 0x66, 0xed, 0x0a, 0xdf, 0x1e, 0x85, 0xcc, 0x26, 0xba, 0xf4, 0x53, 0x4c, 0xc9, 0x8e,
  0xd0, 0x86, 0x59, 0xd4, 0x2b, 0x05, 0x1f, 0xc2, 0x87, 0x89, 0xc6, 0x16, 0xb4, 0x1b, 0xd1, 0xa1,
  0x45, 0x8a, 0x0c, 0x75, 0xe7, 0x8d, 0x25, 0x97, 0x00, 0xb0, 0x68, 0x04, 0x70, 0x59, 0x70, 0x75,
  0xff, 0x7e, 0xcb, 0x4b, 0x28, 0x2d, 0x8d, 0xc9, 0x07, 0xe2, 0x85, 0x93, 0x6a, 0xc6, 0xce, 0xf2,
  0x94, 0xf3, 0x29, 0x58, 0x5b, 0x99, 0xa2, 0xe8, 0xe3, 0x0b, 0x14, 0xf7, 0x3e, 0x40, 0xe6, 0x8b,
  0x6f, 0x71, 0x6a, 0xc0, 0xcf, 0x8d, 0xd4, 0x65, 0xa6, 0x25, 0xd3, 0x8f, 0xdf, 0x27, 0x83, 0xff,
  0x65, 0xb4, 0x39, 0x14, 0x5b, 0xc2, 0x19, 0xd4, 0x81, 0x0c, 0x1e, 0x70, 0xf4, 0x38, 0x51, 0xfa,
  0x6b, 0x4a, 0x5e, 0x13, 0x65, 0x96, 0x16, 0x1f, 0x37, 0x9a, 0x2d, 0xe6, 0xf2, 0x07, 0x2f, 0x7a,
  0x04, 0x3e, 0x30, 0xb1, 0xca, 0xd9, 0x21, 0xa9, 0x70, 0xfa, 0x76, 0x7d, 0x58, 0x19, 0xe3, 0x45,
  0xb7, 0xbe, 0x1e, 0x5f, 0xb1, 0x06, 0x4d, 0xa6, 0x10, 0x29, 0x05, 0x17, 0x6b, 0x00, 0xbb, 0x4e,
  0x8f, 0xe8, 0x09, 0xfc, 0x1c, 0x48, 0x90, 0x5d, 0x56, 0xda, 0x2d, 0xe0, 0xed, 0x35, 0x5a, 0x44,
  0xbe, 0x91, 0xc0, 0x5e, 0xdb, 0x27, 0x29, 0xbb, 0xe6, 0x72, 0x28, 0xe1, 0x36, 0xa5, 0x82, 0x3f,
  0xa9, 0x13, 0x61, 0x70, 0x3f, 0x17, 0xc3, 0xb1, 0xac, 0x8d, 0x9f, 0x48, 0x68, 0x79, 0x8b, 0x48,
  0x30, 0xd1, 0x5a, 0x26, 0xe2, 0x33, 0x9d, 0x7a, 0xc8, 0x69, 0xbb, 0xa4, 0x32, 0x9f, 0xa2, 0xc0,
  0x15, 0x8f, 0x8a, 0x15, 0x41, 0xd2, 0xde, 0x5f, 0xc7, 0x37, 0x7d, 0x72, 0x00, 0x45, 0x02, 0x93,
  0xa9, 0x71, 0x2c, 0x28, 0x2a, 0xaa, 0xa9, 0xfd, 0xce, 0x35, 0xfa, 0x52, 0xcf, 0x05, 0x89, 0x2f,
  0x86, 0xa3, 0x86, 0x74, 0x54, 0x93, 0x5a, 0xa2, 0xd0, 0xbd, 0x4b, 0xfe, 0x5c, 0x9f, 0xa2, 0xa5,
  0x7f, 0x97, 0x0e, 0x33, 0xcf, 0x6a, 0xc5, 0x3f, 0x08, 0x6b, 0x9e, 0xcd, 0x23, 0x63, 0x44, 0x97,
  0x32, 0x2f, 0xc2, 0x01, 0x6a, 0xd5, 0x14, 0x04, 0x94, 0xfb, 0xd9, 0x07, 0x71, 0xc3, 0x70, 0x16,
  0x28, 0x9b, 0x43, 0xe6, 0x5b, 0xa6, 0xb5, 0x71, 0x8f, 0xd1, 0x80, 0xbe, 0x88, 0xbb, 0x16, 0xe8,
  0xb1, 0xf4, 0xbf, 0xe2, 0x56, 0x98, 0x29, 0xb5, 0xbf, 0xd4, 0x21, 0x11, 0x4f, 0x4f, 0x04, 0x5e,
  0xd5, 0x1e, 0x60, 0x1c, 0xdd, 0x9f, 0xdf, 0x1d, 0xb5, 0x56, 0xaa, 0xf6, 0xa8, 0xdc, 0x2b, 0xaf,
  0x61, 0x30, 0x41, 0x9d, 0xc2, 0xbf, 0xed, 0x96, 0xd0, 0x58, 0xfe, 0xd9, 0x22, 0xec, 0x2d, 0x1d,
  0xf3, 0x92, 0xf7, 0x24, 0x5d, 0x7f, 0x40, 0x40, 0x8b, 0x6c, 0x1a, 0x1a, 0x81, 0xd3, 0x0a, 0x8e,
  0xf9, 0xea, 0xe1, 0xf0, 0x77, 0xbf, 0xea, 0x33, 0x79, 0xae, 0x6d, 0x8c, 0x46, 0xc5, 0x84, 0xbd,
  0xf6, 0x2e, 0x24, 0xc7, 0xf1, 0x1f, 0xe3, 0x36, 0xbf, 0x3f, 0x14, 0xe1, 0xfd, 0x9e, 0x09, 0x95,
  0x1c, 0xa0, 0x12, 0x45, 0xd4, 0xe2, 0x4f, 0xff, 0xdc, 0xdf, 0x9f, 0x10, 0x6c, 0x79, 0xf9, 0x0a,
  0x34, 0xaf, 0x34, 0x73, 0x8d, 0x9c, 0x18, 0xca, 0x40, 0x98, 0xdd, 0x14, 0x67, 0x64, 0x2e, 0x31,
  0x15, 0x14, 0x31, 0x19, 0x82, 0x78, 0xc0, 0xe0, 0xb2, 0x38, 0x3d, 0xbe, 0xa9, 0xd0, 0x14, 0x54,
  0x03, 0xdb, 0xd4, 0x32, 0xc5, 0x22, 0x69, 0x7f, 0x05, 0x2d, 0x17, 0x12, 0x55, 0x17, 0xcc, 0x78,
  0x40, 0x8b, 0x1e, 0x8a, 0xef, 0x0a, 0x67, 0x98, 0x33, 0x25, 0x97, 0x53, 0x30, 0xd5, 0x0b, 0xc0,
  0x69, 0xe5, 0x02, 0x26, 0xf8, 0x05, 0xb1, 0xa1, 0x37, 0x17, 0x3a, 0xdb, 0x80, 0xdd, 0xb8, 0x97,
  0xfb, 0xed, 0x03, 0xee, 0x10, 0xed, 0xf0, 0x65, 0x76, 0x91, 0x4e, 0xe9, 0x66, 0x32, 0x4a, 0x44,
  0xbb, 0x7c, 0xc7, 0xb9, 0x0d, 0x0f, 0x18, 0x1d, 0xf6, 0x15, 0xd5, 0x74, 0x6a, 0xba, 0x98, 0x88,
  0xc7, 0xf2, 0xf6, 0x41, 0xa0, 0x5c, 0x24, 0x35, 0xd3, 0x8c, 0x1e, 0xea, 0x61, 0x27, 0x96, 0x96,
  0x08, 0x19, 0x2e, 0x87, 0xaf, 0x67, 0xb6, 0x19, 0x15, 0xa1, 0x54, 0x0f, 0xe3, 0x16, 0x88, 0x0c,
  0xc6, 0x65, 0x69, 0x72, 0xa8, 0xb7, 0x8f, 0xb3, 0xc0, 0xbf, 0x1f, 0xd4, 0xbe, 0x3c, 0x7e, 0x7e,
  0x52, 0xcd, 0x6f, 0x88, 0xae, 0x87, 0x1e, 0xf1, 0x70, 0xbe, 0xce, 0x35, 0x9e, 0xb6, 0x79, 0x5e,
  0xbb, 0xfc, 0x1f, 0x10, 0x21, 0xb3, 0x3a, 0x6f, 0x9b, 0xb0, 0x14, 0x5c, 0x99, 0xdd, 0xf5, 0xe5,
  0x25, 0x28, 0xe9, 0x0b, 0x8a, 0x9b, 0x58, 0xf8, 0x4f, 0x43, 0x14, 0xc6, 0x2b, 0x91, 0x6a, 0x61,
  0x9b, 0x7d, 0xc6, 0x08, 0x14, 0xef, 0xae, 0x23, 0x02, 0xe0, 0xa1, 0x46, 0x8e, 0x39, 0xc5, 0xe5,
  0x71, 0x32, 0x1a, 0x05, 0xd0, 0xb8, 0x76, 0x4c, 0xf0, 0xa1, 0x51, 0x10, 0x9c, 0x11, 0x8d, 0xd7,
  0x7f, 0x2f, 0xa7, 0xe6, 0x8a, 0xbc, 0x57, 0x29, 0xbe, 0xc6, 0xf5, 0xa4, 0x57, 0x65, 0x04, 0x31,
  0x22, 0x1a, 0x0c, 0xe8, 0x87, 0x3a, 0x9e, 0xc6, 0x38, 0x0a, 0x85, 0x1d, 0xd4, 0x13, 0xad, 0x9e,
  0x02, 0xd8, 0xd8, 0xe7, 0x8a, 0x28, 0xd6, 0x92, 0xa7, 0xba, 0xfe, 0x9c, 0xe3, 0xce, 0x57, 0x93,
  0xbd, 0xa6, 0x9b, 0xda, 0xbf, 0x7e, 0x8e, 0x22, 0xcb, 0x9e, 0x54, 0x44, 0x56, 0x3d, 0xae, 0x7c,
  0x5a, 0xb2, 0x0d, 0x96, 0x43, 0x58, 0x3c, 0xa8, 0x13, 0x7e, 0x2e, 0x93, 0x75, 0x7c, 0xc7, 0x67,
  0xa6, 0xd0, 0xbe, 0xb6, 0xf9, 0x33, 0x7f, 0xfc, 0x8b, 0x54, 0x8f, 0xb2, 0x52, 0xfb, 0x86, 0x34,
  0x92, 0x8b, 0xbc, 0xba, 0xcc, 0xd7, 0xce, 0x41, 0x94, 0x3a, 0x49, 0x56, 0xe7, 0xba, 0xa4, 0xf3,
  0x7d, 0xf2, 0x38, 0x05, 0xc2, 0xba, 0x31, 0xd5, 0x72, 0x09, 0xac, 0x09, 0x79, 0x4f, 0x89, 0x11,
  0x64, 0x52, 0xbc, 0x80, 0xc2, 0x9d, 0x02, 0x05, 0x10, 0x4a, 0xb4, 0x8a, 0xd5, 0xb2, 0x1f, 0xb8,
  0xea, 0x16, 0x5f, 0x74, 0x2c, 0x47, 0xf0, 0xaa, 0x4e, 0x52, 0xca, 0x10, 0x65, 0x5d, 0xd9, 0x3f,
  0x5e, 0xad, 0xd0, 0xe1, 0x64, 0xce, 0x8a, 0xae, 0x5a, 0xee, 0x3a, 0x8f, 0x8b, 0xcf, 0x58, 0x04,
  0x7b, 0xca, 0x22, 0x1a, 0xfb, 0xfe, 0xf2, 0x00, 0x8e, 0xdb, 0xe2, 0xc2, 0x4c, 0x1b, 0xd0, 0x91,
  0x8d, 0xd6, 0x20, 0x67, 0x70, 0xf9, 0x83, 0x85, 0x1b, 0xcc, 0x13, 0x60, 0x97, 0x0f, 0xf6, 0xa7,
  0xf6, 0xc4, 0xf3, 0x93, 0xf2, 0x44, 0xcc, 0x49, 0x69, 0x40, 0xa9, 0x94, 0xfd, 0xf7, 0xa1, 0x88,
  0xb8, 0x43, 0xb5, 0x82, 0x3b, 0x00, 0x78, 0x85, 0x24, 0x04, 0xa3, 0x13, 0x21, 0x72, 0x58, 0x73,
  0xbe, 0xda, 0x76, 0x0b, 0x11, 0x94, 0x34, 0xd3, 0x6c, 0x9c, 0xfa, 0x2f, 0x25, 0x41, 0xe1, 0x7e,
  0x2e, 0x03, 0xea, 0x91, 0xc9, 0x77, 0xa7, 0xe3, 0x76, 0x05, 0xd9, 0x2d, 0x2e, 0x5f, 0xc7, 0x32,
  0xe8, 0xb3, 0x3c, 0x91, 0x07, 0xc6, 0xd9, 0x88, 0xf5, 0xc0, 0x84, 0xd6, 0x83, 0x44, 0x4f, 0x20,
  0x9e, 0x94, 0xf6, 0xea, 0xfe, 0x93, 0xf7, 0xce, 0x49, 0x84, 0xb7, 0x44, 0x60, 0xfc, 0x9d, 0x48,
  0x20, 0x28, 0xa4, 0x98, 0x89, 0xdf, 0xca, 0xce, 0x5e, 0x68, 0x83, 0xaa, 0xf5, 0x89, 0x39, 0x5a,
  0x59, 0x20, 0x4c, 0x6e, 0xdb, 0xa8, 0x01, 0xf8, 0x74, 0x43, 0x48, 0xf1, 0xce, 0x30, 0xcd, 0xd0,
  0xd9, 0x9c, 0x00, 0xa5, 0x0f, 0xa5, 0xb9, 0xb7, 0x23, 0x5f, 0xd7, 0x8a, 0x59, 0x50, 0xb5, 0xb0,
  0x36, 0xf1, 0x7f, 0x81, 0xdb, 0xcb, 0x53, 0xdc, 0x0d, 0x1c, 0x5c, 0x43, 0x9e, 0x94, 0xad, 0x12,
  0x79, 0x62, 0xae, 0x0f, 0x3f, 0x3c, 0x02, 0x62, 0x3f, 0x9e, 0xca, 0x39, 0x78, 0xf9, 0x08, 0x8d,
  0x47, 0xee, 0x55, 0x14, 0xdd, 0x1a, 0xf8, 0x8d, 0x40, 0x1c, 0x0f, 0xcd, 0x9a, 0xc7, 0x33, 0xb7,
  0x0a, 0xe7, 0x0e, 0x8a, 0xf6, 0xfc, 0x0e, 0xb0, 0xdb, 0x60, 0xec, 0x5b, 0xe8, 0xb6, 0x8f, 0xd2,
  0xca, 0xe9, 0x91, 0x91, 0xde, 0xb7, 0xd3, 0x1e, 0xc6, 0x91, 0x84, 0x07, 0x58, 0xc2, 0x37, 0xdc,
  0xe1, 0x50, 0x13, 0xaf, 0x45, 0xaf, 0x66, 0xe3, 0x02, 0xd7, 0xc8, 0x7c, 0x1d, 0x58, 0x9e, 0x96
  };

  unsigned char dilithium2_m_buf[] = {
  0x6a, 0x9a, 0xab, 0xa8, 0xf3, 0x0b, 0x95, 0x60, 0x20, 0x77, 0x9e, 0x8f, 0x45, 0xc8, 0xe8, 0x0d,
  0x43, 0x9b, 0x05, 0x7c, 0x69, 0x4b, 0x0a, 0x4f, 0xf1, 0xf9, 0x85, 0x21, 0x9a, 0x81, 0x70, 0x79,
  0x09, 0xd8, 0x09, 0x2c, 0x07, 0xf4, 0x98, 0xf4, 0xb5, 0x94, 0xd7, 0x2f, 0x1d, 0x32, 0x49, 0x77,
  0xfa, 0xd9, 0x71, 0x36, 0xfb, 0x41, 0x2e, 0xcb, 0xd0, 0x83, 0x4b };

  unsigned char dilithium2_sig_buf[] = {
  0x39, 0x54, 0x74, 0xc5, 0x75, 0x36, 0x0d, 0x88, 0x80, 0xcf, 0x4a, 0x6e, 0x32, 0xc9, 0x6a, 0xeb,
  0x77, 0x3e, 0x8a, 0x5b, 0x8f, 0x08, 0x1f, 0x95, 0xa1, 0x08, 0x33, 0x08, 0xdd, 0xdf, 0x2c, 0x11,
  0xb0, 0x36, 0xe8, 0x33, 0x8b, 0xcd, 0x74, 0xf9, 0xc0, 0x5a, 0x0d, 0xbc, 0x59, 0xf6, 0xd5, 0x82,
  0xc9, 0xe1, 0x67, 0x7b, 0xa7, 0x6a, 0xad, 0x66, 0xac, 0xd3, 0x25, 0x0d, 0xab, 0xcd, 0x6f, 0xf8,
  0x44, 0x10, 0x75, 0xed, 0xea, 0x8e, 0xae, 0xc9, 0x92, 0xe4, 0xb4, 0x1c, 0x29, 0x79, 0xb3, 0x1e,
  0x8d, 0x50, 0xdd, 0x2a, 0xf0, 0x2e, 0xce, 0x45, 0x0d, 0xff, 0x0e, 0x92, 0x3f, 0x57, 0xe1, 0xca,
  0x71, 0xa1, 0xff, 0x6e, 0xe8, 0x90, 0xe7, 0x5d, 0x4b, 0x07, 0xc1, 0xd0, 0x86, 0x1f, 0x38, 0x1e,
  0xd0, 0xa6, 0xb2, 0xb2, 0x82, 0x01, 0xaa, 0xe1, 0x84, 0x64, 0xbd, 0x70, 0xa5, 0x3d, 0xc2, 0x58,
  0x55, 0x9e, 0x3e, 0xad, 0x95, 0x96, 0x28, 0xc0, 0x8d, 0xd3, 0x62, 0x2e, 0x45, 0xed, 0x5d, 0x4f,
  0xf0, 0x4b, 0xca, 0x4f, 0x3d, 0xa4, 0x61, 0x65, 0x17, 0xfd, 0xd8, 0x37, 0x09, 0xf7, 0x5f, 0x9c,
  0x35, 0x0c, 0x4d, 0xda, 0x6d, 0x5a, 0xed, 0x78, 0x5e, 0xa4, 0x19, 0xda, 0x72, 0xc0, 0xc2, 0x67,
  0x28, 0x5c, 0x96, 0x16, 0x7b, 0x15, 0x8b, 0xfb, 0x68, 0x01, 0xd0, 0x65, 0xa9, 0x35, 0x32, 0x59,
  0xe7, 0x7a, 0x99, 0xaf, 0xd9, 0xb9, 0x12, 0x3f, 0xd9, 0xec, 0x3b, 0x31, 0x9f, 0x9f, 0xb4, 0x23,
  0x09, 0x70, 0x9e, 0xc1, 0x51, 0x2c, 0xd6, 0x7e, 0xd0, 0x5f, 0x8d, 0x7c, 0x51, 0x48, 0x58, 0x79,
  0xac, 0x8d, 0xdd, 0x1d, 0x61, 0xa4, 0xa8, 0x67, 0xa7, 0x8b, 0x65, 0x87, 0xb3, 0x54, 0xa6, 0x15,
  0xf9, 0x19, 0x04, 0xf1, 0x87, 0x41, 0x72, 0xac, 0xe9, 0x87, 0xb3, 0xd9, 0xda, 0x97, 0x5d, 0xa4,
  0xa3, 0x5c, 0x77, 0x55, 0x0e, 0x3f, 0x5f, 0x27, 0x78, 0xc8, 0x70, 0x39, 0x06, 0xf7, 0xf4, 0xa7,
  0x39, 0x4f, 0xf8, 0x67, 0x9a, 0x66, 0x4f, 0x8d, 0xb5, 0xad, 0x85, 0x17, 0x8b, 0x2e, 0x76, 0xf1,
  0x22, 0x24, 0x7b, 0xea, 0x19, 0xaf, 0x96, 0x12, 0x84, 0xc9, 0xb3, 0x89, 0x17, 0x9e, 0x9b, 0x12,
  0xd1, 0x33, 0xea, 0x30, 0x7e, 0xbb, 0x2c, 0x19, 0x73, 0x4c, 0xd5, 0x7a, 0x24, 0x86, 0x37, 0xdf,
  0xc6, 0x58, 0x28, 0x38, 0x43, 0x9b, 0xcc, 0x97, 0x5b, 0x3c, 0x74, 0xc0, 0x28, 0xaa, 0x3a, 0x56,
  0xd8, 0x4c, 0x2d, 0xd1, 0xd1, 0x27, 0x10, 0xac, 0x91, 0x42, 0x75, 0x67, 0x5c, 0xcf, 0x2e, 0xee,
  0x64, 0x4a, 0xf7, 0x21, 0xf2, 0xc9, 0xfb, 0xf7, 0xd6, 0xa4, 0x82, 0x42, 0x30, 0x0a, 0x00, 0xef,
  0x2b, 0x73, 0x38, 0xd5, 0x04, 0xf3, 0x5e, 0xa9, 0xa0, 0x02, 0x35, 0x50, 0x7c, 0x9f, 0xac, 0xe6,
  0xc8, 0xd0, 0x65, 0x1d, 0x87, 0x16, 0x15, 0x3c, 0x68, 0x02, 0x36, 0x22, 0x2e, 0x7e, 0x99, 0x77,
  0x1c, 0xa4, 0x65, 0x90, 0x9d, 0x72, 0xdf, 0xcd, 0xb9, 0x18, 0x31, 0xba, 0x92, 0x24, 0x54, 0x64,
  0xd3, 0xf6, 0x23, 0x76, 0xed, 0xad, 0x83, 0xc6, 0x4d, 0x83, 0xd9, 0x73, 0xd1, 0xb0, 0x41, 0x68,
  0x43, 0xce, 0x26, 0xb5, 0x0b, 0x7b, 0xe8, 0x09, 0xb7, 0x26, 0x0d, 0x16, 0x99, 0xcf, 0x54, 0x8a,
  0x6b, 0x00, 0x48, 0x30, 0xdc, 0x79, 0x5e, 0xff, 0x07, 0xb5, 0x49, 0xf8, 0x48, 0xb9, 0x56, 0x37,
  0x0f, 0x33, 0xe7, 0x66, 0x07, 0x03, 0x3b, 0xab, 0x4b, 0xf5, 0x23, 0x1c, 0xe9, 0x5d, 0xa5, 0x3d,
  0x8a, 0xd4, 0xf8, 0xc2, 0x45, 0xed, 0x1c, 0x47, 0x7e, 0xaa, 0xd5, 0xae, 0xdc, 0x18, 0xdf, 0xfb,
  0x9a, 0x68, 0x68, 0xd9, 0x0d, 0xf9, 0xd9, 0x34, 0x92, 0x1d, 0xab, 0x55, 0x3b, 0x16, 0xf2, 0xc0,
  0x9d, 0xdb, 0xd3, 0xd8, 0x97, 0xa4, 0x6e, 0xe3, 0x17, 0x8f, 0x3b, 0x1c, 0x3b, 0x34, 0xe3, 0x48,
  0x27, 0x26, 0xea, 0x23, 0xf2, 0x9f, 0xe0, 0x04, 0x15, 0x9f, 0x7a, 0x82, 0x19, 0x89, 0x40, 0xcc,
  0x20, 0xb8, 0x5e, 0x67, 0xeb, 0x6a, 0xe2, 0x72, 0x65, 0xd5, 0x79, 0xce, 0xc5, 0x2c, 0x2c, 0xed,
  0x82, 0x76, 0xeb, 0x1f, 0x58, 0x4f, 0x59, 0xa6, 0x24, 0xeb, 0x5b, 0xbe, 0x4c, 0x97, 0x55, 0xbf,
  0x4a, 0x81, 0xdd, 0x4c, 0x50, 0xaa, 0xe4, 0x2f, 0x64, 0xcf, 0xed, 0x77, 0x7c, 0x06, 0x7f, 0xe2,
  0x61, 0xe9, 0xce, 0xc8, 0x2c, 0x31, 0x1d, 0x4a, 0x99, 0xb5, 0x70, 0x86, 0x3f, 0x00, 0x1f, 0xc2,
  0x71, 0x88, 0x40, 0x78, 0x87, 0x33, 0xba, 0x64, 0x1c, 0x5b, 0xc9, 0x6c, 0xc0, 0x32, 0x5b, 0x93,
  0x8b, 0xf1, 0x64, 0x2d, 0x0e, 0xda, 0x50, 0x35, 0x9c, 0x93, 0x27, 0x9f, 0x9d, 0x06, 0x91, 0xe2,
  0xf9, 0xdf, 0x80, 0xd3, 0xe5, 0x52, 0x91, 0xe3, 0x20, 0x07, 0x4e, 0x89, 0x35, 0x09, 0xeb, 0xd4,
  0x2c, 0xe6, 0x6e, 0x98, 0xf9, 0x39, 0xb0, 0x37, 0x58, 0xf0, 0xfd, 0x67, 0x2c, 0xc6, 0xf3, 0xa9,
  0x1c, 0xf8, 0x8a, 0x98, 0x10, 0xf6, 0x1d, 0x66, 0x5b, 0x99, 0x73, 0x73, 0xee, 0xec, 0x43, 0xcf,
  0x05, 0x06, 0x81, 0xaa, 0xea, 0xec, 0xa7, 0xbd, 0xaf, 0xd1, 0x27, 0x15, 0x70, 0x71, 0x1b, 0x1e,
  0x21, 0xad, 0x97, 0x37, 0xf3, 0x75, 0x22, 0xac, 0x7c, 0x02, 0x5c, 0x08, 0x01, 0x7e, 0x9d, 0x20,
  0x93, 0x98, 0x6d, 0x51, 0xd5, 0xba, 0x60, 0x08, 0xbd, 0x01, 0xcd, 0xaf, 0x8c, 0xff, 0xe8, 0xdb,
  0xbc, 0x34, 0xf7, 0xf5, 0x86, 0x48, 0x99, 0x0e, 0x11, 0x94, 0xec, 0x59, 0x68, 0x24, 0x6e, 0xa9,
  0xe9, 0x72, 0xa3, 0x41, 0xc0, 0x16, 0x60, 0x97, 0x38, 0x2d, 0x92, 0xee, 0xbd, 0x00, 0xee, 0x4a,
  0x6c, 0x82, 0x16, 0x6f, 0xba, 0xa9, 0x52, 0xbe, 0x1f, 0x98, 0xd5, 0x48, 0x70, 0x5c, 0x6e, 0xa8,
  0xb0, 0x87, 0x64, 0x5d, 0xff, 0x9a, 0x78, 0x4e, 0x2e, 0x8c, 0x26, 0xca, 0xea, 0x13, 0xb8, 0xf2,
  0x12, 0xac, 0x56, 0x54, 0xb7, 0x24, 0x6e, 0xcf, 0x2a, 0x70, 0xeb, 0x03, 0xf4, 0xc6, 0xef, 0x94,
  0x26, 0xf2, 0xac, 0xb1, 0xe5, 0xa4, 0xf5, 0x9a, 0xd6, 0x17, 0xad, 0x4d, 0x99, 0xec, 0x3b, 0xfd,
  0xf7, 0xdf, 0x28, 0x49, 0x38, 0x6f, 0x5e, 0xf6, 0xde, 0xa5, 0x38, 0x20, 0x91, 0x98, 0xb1, 0x59,
  0x20, 0x2c, 0x48, 0x97, 0xa2, 0x66, 0x0b, 0xea, 0x9e, 0x60, 0x7b, 0x1a, 0xaf, 0x3b, 0xd1, 0xbc,
  0xd3, 0x68, 0xb0, 0x11, 0x23, 0x19, 0x54, 0xf1, 0x59, 0x6b, 0xb6, 0x29, 0xb9, 0x1c, 0xa2, 0x89,
  0xb0, 0xba, 0xf7, 0x06, 0xb5, 0xb9, 0xc4, 0x62, 0x2e, 0xe2, 0xc1, 0x9c, 0x95, 0xe8, 0x72, 0x54,
  0x8b, 0x18, 0x57, 0xc2, 0x5f, 0x8b, 0xcf, 0xbf, 0x6a, 0x9f, 0x7e, 0x77, 0x0b, 0xdb, 0x2a, 0x3d,
  0xc7, 0xda, 0x2d, 0x56, 0xf4, 0x36, 0x39, 0x16, 0x67, 0x82, 0x28, 0x3f, 0x55, 0x22, 0x78, 0x59,
  0x6f, 0x3d, 0x5a, 0xa6, 0x7b, 0xb4, 0x8a, 0xa6, 0x3c, 0x99, 0xca, 0x03, 0x72, 0x95, 0xea, 0xf5,
  0x6d, 0xa4, 0x11, 0x86, 0xef, 0x0c, 0x9c, 0x8d, 0xe5, 0xd3, 0x4c, 0x54, 0x72, 0xf5, 0x53, 0xa9,
  0x9a, 0xfa, 0xb7, 0xe2, 0x89, 0xf3, 0x5f, 0x11, 0x44, 0x4d, 0x19, 0x66, 0x8a, 0xe7, 0xd1, 0x19,
  0x42, 0xfc, 0x29, 0x32, 0x5e, 0xd3, 0x32, 0x20, 0x49, 0xb7, 0xee, 0xc7, 0x5a, 0x90, 0x8f, 0x12,
  0xc1, 0x17, 0x95, 0x6f, 0xb4, 0xe5, 0xee, 0x14, 0x11, 0xdb, 0xc3, 0x0f, 0x65, 0x03, 0x37, 0xa1,
  0x44, 0xf8, 0x67, 0xa0, 0x00, 0xf9, 0x7f, 0x99, 0x3e, 0xd5, 0x5c, 0xe8, 0x78, 0x26, 0xdc, 0x10,
  0xdb, 0x58, 0xbb, 0xf8, 0x96, 0x63, 0x28, 0x16, 0xb0, 0xf3, 0x05, 0x61, 0x26, 0x22, 0xb3, 0x40,
  0x9a, 0xc4, 0xfb, 0x17, 0xe3, 0xc9, 0x72, 0x0b, 0xf5, 0x64, 0xf2, 0x5c, 0x8e, 0xed, 0xe9, 0x47,
  0x39, 0x37, 0x7c, 0x2c, 0x70, 0xc4, 0x61, 0x0f, 0xb6, 0x86, 0x72, 0xf2, 0x83, 0x2e, 0x5a, 0x07,
  0x7e, 0xe7, 0x6f, 0x7f, 0x6c, 0xef, 0x9a, 0x61, 0xc8, 0xbf, 0x96, 0xa7, 0x1d, 0xb7, 0xdd, 0x9c,
  0x74, 0x7b, 0xd4, 0xa0, 0xa1, 0xc7, 0x24, 0x57, 0x76, 0xe2, 0x54, 0x64, 0xda, 0x0d, 0xed, 0xab,
  0x83, 0xf7, 0xb3, 0x8f, 0x1f, 0x88, 0x83, 0x7b, 0xf2, 0x1e, 0x30, 0x26, 0x0a, 0xf8, 0xc0, 0x24,
  0xe1, 0xfe, 0x8d, 0x1a, 0x38, 0xb7, 0x52, 0x61, 0x58, 0xa3, 0xea, 0x0a, 0x77, 0x18, 0xca, 0xab,
  0x45, 0x29, 0x6a, 0x3b, 0x53, 0xc0, 0x27, 0x9f, 0x2a, 0x18, 0x94, 0x88, 0xfe, 0x99, 0x88, 0x23,
  0xc9, 0xa1, 0x5e, 0xd7, 0x88, 0x0d, 0x53, 0xb8, 0x78, 0x4b, 0xc7, 0x43, 0x75, 0xf4, 0x00, 0x0e,
  0x09, 0xb4, 0x39, 0x57, 0x1f, 0x22, 0x81, 0x9e, 0x91, 0x74, 0xac, 0x85, 0x2b, 0x4f, 0x51, 0x0a,
  0xce, 0x47, 0xca, 0xe4, 0x48, 0xb6, 0xe8, 0xf9, 0x6c, 0x44, 0xc3, 0xc8, 0xe1, 0xa1, 0x12, 0x79,
  0x3d, 0x36, 0x55, 0xaa, 0xd0, 0xb5, 0xc4, 0x8c, 0xa5, 0xe7, 0x73, 0xb1, 0xef, 0x59, 0x35, 0x82,
  0xaa, 0xb8, 0x3b, 0x79, 0x14, 0x30, 0x64, 0xb4, 0x37, 0xf9, 0xf8, 0xce, 0x3b, 0xfb, 0xd4, 0xb1,
  0x8a, 0xf5, 0xaf, 0x9f, 0x58, 0xf3, 0x47, 0xf9, 0x9b, 0x23, 0x70, 0x6f, 0x49, 0x9a, 0xa4, 0xed,
  0xff, 0x18, 0x70, 0xbd, 0x70, 0x8d, 0x9f, 0xae, 0x11, 0x11, 0xa5, 0xa2, 0x16, 0xd6, 0x6e, 0x07,
  0xaa, 0x58, 0x30, 0xb8, 0x10, 0xe6, 0x91, 0x79, 0x66, 0x82, 0x8d, 0x24, 0x36, 0xb8, 0xd4, 0x71,
  0x89, 0x7d, 0x96, 0x10, 0x15, 0x8a, 0xbd, 0x9b, 0xc2, 0x49, 0x7a, 0x9f, 0x27, 0x29, 0xce, 0x4a,
  0xea, 0xed, 0xe8, 0xe8, 0x16, 0x4e, 0xe6, 0x2c, 0x1a, 0x3a, 0xf2, 0x66, 0xc4, 0xe3, 0xa9, 0x20,
  0xa7, 0x39, 0xbf, 0x38, 0x4f, 0x78, 0xf6, 0x65, 0xf1, 0xe0, 0x1f, 0x30, 0x48, 0xe7, 0x6d, 0xfb,
  0xe3, 0xc2, 0x47, 0x12, 0xf5, 0x93, 0xd8, 0xd1, 0x10, 0x3c, 0x99, 0x2c, 0xf0, 0x36, 0x0c, 0x44,
  0x12, 0xe3, 0x2f, 0x63, 0x34, 0xaa, 0x2d, 0x68, 0x87, 0x63, 0x58, 0x28, 0x09, 0xf6, 0xea, 0x15,
  0x84, 0x72, 0x56, 0x1f, 0x8f, 0x8e, 0x33, 0xa1, 0xec, 0x7f, 0xec, 0x86, 0x6b, 0xee, 0x81, 0x36,
  0xa3, 0x5a, 0x74, 0x38, 0x2e, 0x3a, 0xe4, 0xad, 0x95, 0xfc, 0x0d, 0x24, 0x2c, 0xd3, 0x98, 0x77,
  0x3f, 0xf8, 0xbf, 0xa7, 0x25, 0x5b, 0x4b, 0xa0, 0x42, 0x5b, 0xad, 0xd7, 0x91, 0x40, 0xf1, 0x38,
  0x9c, 0xe9, 0x92, 0xcb, 0x3e, 0xe7, 0x3a, 0x4f, 0xf0, 0x11, 0xcb, 0x80, 0x3d, 0x13, 0xed, 0x03,
  0x63, 0x3d, 0x7e, 0x1b, 0x1e, 0x0e, 0x95, 0x4c, 0x23, 0xb1, 0x38, 0xa1, 0x8a, 0x80, 0x38, 0xfa,
  0x89, 0x17, 0x7f, 0xa3, 0xcc, 0x70, 0x33, 0xaa, 0x1c, 0x4c, 0x30, 0x10, 0xe5, 0x8e, 0xc8, 0xc7,
  0xe0, 0xbd, 0x36, 0x90, 0x4b, 0x69, 0x02, 0x2e, 0x11, 0x66, 0xc1, 0xda, 0x8f, 0xed, 0x81, 0x85,
  0x80, 0x1c, 0xac, 0xc6, 0x73, 0x6d, 0xc8, 0x15, 0x2b, 0x4d, 0x03, 0x5e, 0xbd, 0xb7, 0x33, 0xc6,
  0xa0, 0xc6, 0xab, 0xbf, 0x24, 0x86, 0xbe, 0x57, 0x92, 0xff, 0x47, 0x28, 0xf0, 0x5f, 0xa9, 0x25,
  0xc8, 0x1a, 0x3a, 0x27, 0x79, 0xdf, 0xe0, 0xfc, 0x26, 0x87, 0xf7, 0x52, 0xfe, 0xc2, 0x61, 0x3f,
  0x64, 0x85, 0x62, 0xd5, 0x29, 0xe9, 0xd6, 0x71, 0xc5, 0xc8, 0x23, 0x2f, 0x8c, 0x3a, 0x8a, 0xad,
  0x09, 0xe4, 0x85, 0x29, 0xa5, 0xf6, 0xff, 0xa9, 0xc0, 0xd5, 0x1b, 0xcd, 0xf4, 0x3e, 0x58, 0x33,
  0xd9, 0x36, 0x44, 0x1d, 0xd9, 0x7c, 0x5a, 0x8e, 0x82, 0x06, 0xb1, 0x83, 0xc2, 0xab, 0x67, 0x87,
  0x67, 0x5e, 0xd4, 0xd0, 0x6c, 0x3f, 0xca, 0x80, 0x7c, 0x40, 0x82, 0xb8, 0x48, 0xe8, 0x21, 0x0a,
  0x64, 0xf6, 0xaf, 0xcf, 0x97, 0x83, 0x0d, 0x90, 0x0c, 0x81, 0x6c, 0x16, 0x3c, 0x98, 0x54, 0xd2,
  0x24, 0xde, 0x34, 0xf7, 0x04, 0x3e, 0xa0, 0x4a, 0xeb, 0xf8, 0xb1, 0xbb, 0x96, 0xfa, 0x0d, 0xf3,
  0x4c, 0x08, 0xbb, 0x79, 0x9e, 0x99, 0x7d, 0x09, 0x7f, 0x2d, 0xaf, 0x70, 0xad, 0x7e, 0x77, 0x1f,
  0x9c, 0x65, 0x5b, 0x6e, 0xfd, 0x04, 0xe7, 0x44, 0x3e, 0xb2, 0xbe, 0x43, 0x24, 0xa9, 0xf4, 0xdd,
  0x6e, 0x7b, 0xd0, 0xca, 0x72, 0x54, 0xae, 0xff, 0x49, 0x30, 0x7b, 0x11, 0xff, 0x2b, 0x57, 0x8d,
  0x25, 0x44, 0xce, 0x62, 0xd8, 0x39, 0x13, 0x50, 0x7c, 0x28, 0x83, 0xf0, 0xb0, 0x48, 0x81, 0x60,
  0x31, 0xea, 0xfe, 0x6b, 0x52, 0x58, 0xdc, 0x9a, 0x4e, 0x6b, 0x3d, 0x6e, 0x3f, 0x49, 0x6d, 0xa7,
  0x5b, 0x1e, 0x58, 0x35, 0x94, 0x00, 0xd3, 0x01, 0x66, 0x90, 0xd7, 0xe3, 0xee, 0xec, 0x98, 0xbf,
  0xc5, 0x35, 0xc6, 0xcc, 0x6f, 0x08, 0x71, 0x7d, 0xe4, 0x82, 0xf3, 0x93, 0x49, 0x2b, 0x8f, 0xcc,
  0x71, 0x82, 0xfc, 0xae, 0x10, 0x9a, 0x20, 0x10, 0x18, 0x1e, 0x29, 0x37, 0xcb, 0x3f, 0x92, 0x96,
  0x8e, 0x8f, 0x32, 0x65, 0xef, 0x20, 0x2c, 0x75, 0xd1, 0xd1, 0x40, 0x81, 0x46, 0x3e, 0x84, 0xf7,
  0xe7, 0x57, 0x5d, 0xd6, 0x13, 0xe4, 0x9c, 0x1c, 0x04, 0x09, 0x83, 0xbe, 0xe3, 0xcc, 0xad, 0x33,
  0x63, 0x54, 0xf9, 0x1d, 0xbb, 0x44, 0xda, 0xa1, 0x3d, 0x51, 0x3e, 0x18, 0xb3, 0x68, 0xc0, 0x11,
  0x28, 0x54, 0xeb, 0x16, 0x8a, 0x7a, 0x02, 0x3f, 0x83, 0x49, 0x90, 0xdf, 0x86, 0x82, 0xc0, 0x80,
  0xec, 0x63, 0x75, 0x41, 0xc8, 0xce, 0xee, 0xa6, 0xf4, 0x6d, 0xf2, 0x9a, 0xff, 0x48, 0x36, 0xb1,
  0x25, 0x21, 0xc1, 0x29, 0x0d, 0xff, 0x3c, 0xbe, 0x40, 0x93, 0x79, 0x72, 0xdb, 0x2b, 0x87, 0xae,
  0x54, 0xf4, 0x07, 0xec, 0x16, 0x37, 0xa1, 0x8d, 0x28, 0xbc, 0x04, 0xa2, 0x1e, 0x32, 0x1d, 0x3f,
  0x9a, 0xca, 0xb6, 0x44, 0xec, 0x78, 0x9c, 0x57, 0xfd, 0xcd, 0xd8, 0x20, 0x4e, 0xa7, 0xc8, 0x19,
  0xe9, 0x12, 0x50, 0xa1, 0xab, 0xba, 0xa1, 0x6f, 0x27, 0xf5, 0xe7, 0xdc, 0xd4, 0x60, 0x54, 0x43,
  0x74, 0x37, 0x12, 0xf0, 0xb9, 0x87, 0x95, 0x21, 0xae, 0xdf, 0x02, 0xf6, 0x9b, 0x43, 0xd7, 0xa2,
  0x93, 0x1c, 0xc3, 0x39, 0xfe, 0xaa, 0x8b, 0xb8, 0xca, 0x46, 0x0a, 0xeb, 0x38, 0x26, 0x65, 0xaa,
  0x64, 0x40, 0x6b, 0xc9, 0x83, 0x98, 0xe5, 0x0b, 0xe7, 0x01, 0xaf, 0xcb, 0xa9, 0xf0, 0x9f, 0x18,
  0xe1, 0x4c, 0x31, 0x1f, 0x62, 0xff, 0xc7, 0x1c, 0x67, 0x37, 0x43, 0xab, 0x0d, 0x08, 0xad, 0x08,
  0x8b, 0x65, 0xad, 0x50, 0x27, 0x2d, 0x61, 0x60, 0x05, 0xff, 0x77, 0x8f, 0x3c, 0x49, 0x3a, 0xde,
  0x55, 0x1c, 0x16, 0xb0, 0xbf, 0x64, 0x97, 0x98, 0x39, 0x04, 0xd6, 0x3c, 0x59, 0xcb, 0xee, 0x0a,
  0x1b, 0x63, 0xdf, 0x9b, 0x58, 0x1a, 0x90, 0xaf, 0x87, 0x37, 0x75, 0x95, 0x02, 0x76, 0x33, 0x67,
  0x34, 0x7e, 0xa5, 0x62, 0x3e, 0x63, 0xc5, 0xed, 0xfb, 0x59, 0x6a, 0x42, 0x47, 0x43, 0xf6, 0xc6,
  0x5f, 0x98, 0x67, 0xfb, 0xc6, 0xa1, 0x1b, 0xc3, 0x7e, 0xc0, 0x2a, 0x3e, 0xcd, 0x0d, 0x39, 0xab,
  0xde, 0x4b, 0xfd, 0xe5, 0x0c, 0xfe, 0xb8, 0xf0, 0x41, 0xc7, 0x84, 0x9d, 0x5e, 0x96, 0x82, 0x5d,
  0x5e, 0x35, 0xa6, 0xcb, 0x7e, 0xf1, 0xf4, 0x84, 0x9e, 0xe1, 0x30, 0x5a, 0x4a, 0xdf, 0x08, 0xf0,
  0x82, 0x4e, 0x96, 0x11, 0xe8, 0xe1, 0x19, 0x66, 0xae, 0x37, 0xae, 0xac, 0xce, 0x9e, 0xb9, 0xec,
  0x05, 0x25, 0xdf, 0xcc, 0xde, 0x80, 0xa7, 0x8e, 0xd4, 0x2f, 0x3f, 0x14, 0xda, 0x52, 0x42, 0x4c,
  0x19, 0x2d, 0xa4, 0x85, 0x0e, 0x8d, 0x71, 0x64, 0x11, 0xd5, 0x2c, 0x72, 0x05, 0x1e, 0x38, 0x4f,
  0xb5, 0x98, 0xec, 0x6a, 0x0e, 0x10, 0x11, 0xe3, 0x47, 0x69, 0xfe, 0x0b, 0xa6, 0x84, 0xec, 0x7b,
  0x1b, 0x24, 0x87, 0x3a, 0x7e, 0xe8, 0xd4, 0x53, 0xd2, 0x2a, 0x5e, 0x3b, 0x40, 0xd6, 0x98, 0x4c,
  0xce, 0x70, 0x2e, 0xd9, 0xac, 0x30, 0x69, 0xc9, 0x5d, 0x18, 0x78, 0x40, 0x7a, 0x05, 0x55, 0x79,
  0xce, 0x5d, 0x02, 0xd3, 0xce, 0xda, 0x23, 0x39, 0x02, 0xdc, 0xee, 0x01, 0x09, 0x9e, 0x98, 0x02,
  0x70, 0x5b, 0x9b, 0xe0, 0x4d, 0x1a, 0x13, 0x6d, 0x94, 0x8f, 0xc0, 0xb1, 0x84, 0x93, 0x6c, 0x66,
  0x13, 0x01, 0xa5, 0x09, 0x80, 0xff, 0x5f, 0x0e, 0xc0, 0x7b, 0xea, 0x81, 0xd0, 0x08, 0x31, 0x08,
  0xe2, 0xfc, 0x05, 0x25, 0x69, 0x99, 0x92, 0x5f, 0x84, 0x2a, 0xe4, 0x4f, 0x9b, 0x91, 0xf8, 0xab,
  0x25, 0x8f, 0xdf, 0xe8, 0xbe, 0x1a, 0x6b, 0x00, 0x47, 0xe0, 0x51, 0x23, 0xa2, 0x79, 0xc9, 0xea,
  0x19, 0x7d, 0x53, 0xe5, 0x6a, 0x77, 0x29, 0xc1, 0xef, 0xaa, 0xd4, 0x7a, 0xb7, 0x1d, 0xab, 0x6a,
  0xdd, 0x20, 0x07, 0xe2, 0x10, 0x43, 0xdd, 0x30, 0xb5, 0xe6, 0x11, 0xa4, 0x82, 0xdc, 0x5c, 0xd9,
  0x3b, 0xc2, 0x70, 0x27, 0xb3, 0xdd, 0x24, 0x09, 0x76, 0x83, 0x57, 0xf7, 0x9c, 0xc3, 0x64, 0x58,
  0xb0, 0x3c, 0x6a, 0x84, 0xcc, 0xc1, 0x25, 0x7d, 0xe0, 0x03, 0xc7, 0xb2, 0xbc, 0x5a, 0x75, 0x46,
  0x60, 0x70, 0x17, 0xc3, 0xcf, 0x0b, 0x9c, 0x53, 0xbe, 0xca, 0x6c, 0xd2, 0x57, 0x56, 0x34, 0x71,
  0x90, 0x4c, 0x03, 0xa6, 0xa3, 0xdc, 0xb2, 0xf6, 0x9b, 0x9d, 0xcb, 0xe4, 0x6c, 0xa7, 0x0d, 0x8a,
  0x07, 0x10, 0x2a, 0x35, 0x45, 0x48, 0x52, 0xab, 0xae, 0xd8, 0xe1, 0xe2, 0xe6, 0x0c, 0x13, 0x17,
  0x2d, 0x2e, 0x60, 0x6c, 0x96, 0xae, 0xbe, 0xc5, 0xd3, 0xda, 0xe2, 0x02, 0x0b, 0x11, 0x2a, 0x2e,
  0x37, 0x39, 0x4c, 0x6d, 0x7e, 0x8a, 0x99, 0x9a, 0xa9, 0xab, 0xac, 0xb2, 0xf0, 0xf3, 0x0c, 0x14,
  0x20, 0x22, 0x2b, 0x36, 0x38, 0x4e, 0x54, 0x59, 0x6e, 0x76, 0x8a, 0xa3, 0xa8, 0xac, 0xc3, 0xd1,
  0xdc, 0xe1, 0xea, 0xfd, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x0d, 0x1b, 0x2e, 0x44 };




int check_test_vec_verify(unsigned char *pk, unsigned pk_len, unsigned char *m, unsigned m_len, unsigned char *sig, unsigned sig_len) {


  gcry_error_t err;
  gcry_sexp_t public_key_sx;
  gcry_sexp_t signature_sx;
  gcry_sexp_t data_sx;

  // pk
  err = gcry_sexp_build(&public_key_sx,
                        NULL,
                        "(public-key (dilithium (p %b) (nbits%u) ))",
                        pk_len,
                        pk,
                        pk_len * 8,
                        NULL);
  if (err)
  {
    fail("error building public key SEXP: %s", gpg_strerror(err));
    goto leave;
  }

  // data
  printf("building data with length %d\n", m_len);
  err = gcry_sexp_build (&data_sx,
        NULL,
        "(data (flags raw) (value %b))", m_len, m, NULL);

  if (err)
  {
    fail("error building msg SEXP: %s", gpg_strerror(err));
    goto leave;
  }

  // sig
  err = gcry_sexp_build (&signature_sx,
      NULL,
      "(sig-val(dilithium(a %b)))", sig_len, sig, NULL);

  if (err)
  {
    fail("error building msg SEXP: %s", gpg_strerror(err));
    goto leave;
  }


  printf("verifying test data\n");
  err = gcry_pk_verify (signature_sx, data_sx, public_key_sx);

leave:
  gcry_sexp_release(public_key_sx);
  gcry_sexp_release(signature_sx);
  gcry_sexp_release(data_sx);
  if(err)
    return 1;
  return 0;
}
int
main (int argc, char **argv)
{

int last_argc = -1;
  char *fname   = NULL;
  unsigned i;
  if (argc)
    {
      argc--;
      argv++;
    }

  while (argc && last_argc != argc)
    {
      last_argc = argc;
      if (!strcmp(*argv, "--"))
        {
          argc--;
          argv++;
          break;
        }
      else if (!strcmp(*argv, "--help"))
        {
          fputs("usage: " PGM " [options]\n"
                "Options:\n"
                "  --verbose       print timings etc.\n"
                "  --debug         flyswatter\n"
                "  --data FNAME    take test data from file FNAME\n",
                stdout);
          exit(0);
        }
      else if (!strcmp(*argv, "--verbose"))
        {
          verbose++;
          argc--;
          argv++;
        }
      else if (!strcmp(*argv, "--debug"))
        {
          verbose += 2;
          debug++;
          argc--;
          argv++;
        }
      else if (!strcmp(*argv, "--data"))
        {
          argc--;
          argv++;
          if (argc)
            {
              xfree(fname);
              fname = xstrdup(*argv);
              argc--;
              argv++;
            }
        }
      else if (!strncmp(*argv, "--", 2))
        die("unknown option '%s'", *argv);
    }


    if(fname)
    {
      check_dilithium_kat(fname, 10496);
      xfree(fname);
    }
    else
    {
      if(check_dilithium_roundtrip())
      {
          fail("check_dilithium_roundtrip() yielded an error, aborting");
      }
      if(check_test_vec_verify(dilithium2_pk_buf, sizeof(dilithium2_pk_buf), dilithium2_m_buf, sizeof(dilithium2_m_buf), dilithium2_sig_buf, sizeof(dilithium2_sig_buf)))
      {
          fail("check_test_vec_verify() yielded an error, aborting");
      }
    }

    printf("Success.\n");
}
